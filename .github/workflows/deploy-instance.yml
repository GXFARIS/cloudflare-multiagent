name: Deploy New Instance

on:
  workflow_dispatch:
    inputs:
      instance_id:
        description: 'Instance ID (e.g., production, staging)'
        required: true
        type: string
      org_id:
        description: 'Organization ID'
        required: true
        type: string
      environment:
        description: 'Environment type'
        required: true
        type: choice
        options:
          - production
          - staging
          - development

jobs:
  deploy-instance:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Create instance configuration
        run: |
          mkdir -p instances
          cat > instances/${{ inputs.instance_id }}.json << EOF
          {
            "instance_id": "${{ inputs.instance_id }}",
            "org_id": "${{ inputs.org_id }}",
            "name": "${{ inputs.environment }} Instance",
            "api_keys": {
              "ideogram": "${{ secrets.IDEOGRAM_API_KEY }}"
            },
            "rate_limits": {
              "ideogram": {
                "rpm": 100,
                "tpm": 50000
              }
            },
            "r2_bucket": "${{ inputs.instance_id }}-images"
          }
          EOF

      - name: Deploy instance
        run: npm run deploy-instance -- --config instances/${{ inputs.instance_id }}.json
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Verify deployment
        run: |
          echo "âœ… Instance ${{ inputs.instance_id }} deployed successfully"
          echo "Organization: ${{ inputs.org_id }}"
          echo "Environment: ${{ inputs.environment }}"
          echo "Config Service: https://config-service-${{ inputs.instance_id }}.workers.dev"
          echo "Image Gen: https://image-gen-${{ inputs.instance_id }}.workers.dev"
